<!DOCTYPE html>
<html>
  <head>
    <title>Fishtron</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="css/my.css" rel="stylesheet" media="screen">
    <link href="css/jquery-ui.css" rel="stylesheet" media="screen">

    <style>
      .main-input { width : 697px; }
      .stdout     { width : 767px; }
      .graph1     { width : 786px; 
                    height: 400px; }
      #texta      { font: 15px Courier, monospace;
                    background-image: url('files/logo3.png'); }

      .slider     { width:400px; position: relative; top:0px;left:10px; }
      .input-for-slider { width:32px; }

    </style>

    <script src="js/jquery.js"></script>
    <script src="js/jquery.ui.js"></script>
    <script src="js/jquery.flot.js"></script>
    <script src="js/underscore.js"></script>
    <script src="js/bootstrap.min.js"></script>


    <script>

var yay = function(){

  var input = $('#yayi').attr('value') ;

  plotData = {} ;

  console.log(input);

  $.ajax({
    //url: 'yay/' + input ,
    url : 'run/' + encodeURIComponent(input) , 
    type: 'GET'  ,
    success: function(wid) {  
        console.log( wid + ' [VYTVOREN]' );

        $('#graph1-link').tab('show');

        setTimeout( function(){out( wid , 1 )} , 100 );
    }
  });

};

var out = function( wid , oid ){
  
  $.ajax({
    url: 'out/' + wid + '/' + oid ,
    type: 'GET'  ,
    success: function( output ) { 

      if( output === '' ){
        console.log( wid + ' [HOTOVO]' ); 
      } else if( output === '_' ){
        //working ale zatim žadnej output
        //console.log( wid + ': working ...' );
        setTimeout( function(){out( wid , oid )} , 100 );
      } else {
        //console.log(wid +': ' + output );

        runCmd( JSON.parse(output) );

        //$('textarea').append(output+'\n');
        //var texta = document.getElementById('texta');
        //texta.scrollTop = texta.scrollHeight - texta.clientHeight;

        setTimeout( function(){out( wid , oid+1 )} , 1 );
      }

    }
  });

};

var clrscr = function(){
    $('textarea').html('');
};

//------------------------

  
var plotData_ = {
  g1 : function(d){for(var i=0;i<14;i+=0.5){d.push([i,Math.sin(i)]);}return d;}([]) ,
  g2 : [[0, 3], [4, 8], [8, 5], [9, 13]],
  g3 : [[0, 12], [7, 12], null, [7, 2.5], [12, 2.5]]
};

var plotData = { };


var flattenPlotData = function( plotData ){
  var ret = [];
  for( var prop in plotData ){
    ret.push( plotData[prop] );
  }
  return ret;
};

var drawPlot = function(){
  $.plot("#placeholder",  flattenPlotData( plotData ) );
};

$(document).ready(function() {

  $('#opts').change(function(){
    var numruns = $('#numruns-input').attr('value');
    var numgens = $('#numgens-input').attr('value');
    var popsize = $('#popsize-input').attr('value');
    $('#yayi').attr('value', 'ssr ' + numruns + ' ' + numgens + ' ' + popsize );
  }) ;

  $('#myTab a').click(function (e) {
    e.preventDefault();
    $( this ).tab('show');
  });


  var initSlider = function( name , opts ){

    var update = function(){
      $('#'+ name +'-input').attr('value' , $('#'+ name +'-slider').slider('value') );
      $('#opts').change();
    };

    $('#'+ name +'-slider').slider({
      min    : opts.min ,
      max    : opts.max ,
      value  : opts.value ,
      change : update,
      slide  : update,
    });

    update();    
  };

  initSlider( 'numruns' , { min : 1 , max : 10    , value : 2   } );
  initSlider( 'numgens' , { min : 0 , max : 100   , value : 10  } );
  initSlider( 'popsize' , { min : 1 , max : 5000  , value : 500 } );

  drawPlot();

});

var cmd1 = {
  type : 'stdout',
  msg  : 'Hello vesmíre!'
};


var cmd2 = function(x,y){
  return {
  type  : 'graph' ,
  graph : 'g4' ,
  data  : [x,y] 
};};

var cmd3 = {
  type : 'multi',
  cmds : [
    cmd1 ,
    cmd2(10,8) , 
    { type : 'stdout', msg : 'Kolem tvé vlastní osy!' } ,
    { type : 'stdout', msg : 'Hnojopražce..?' } ,   
    cmd2(11,7), 
    cmd2(12,16)
  ]
};

var cmd4 = {
  type   : "generationInfo",
  i      : 0,
  ffvals : {
    best  : 0.56473324 ,
    avg   : 0.26871469 ,
    worst : 0.11201199 
  }
};

var cmd5 = {
  type   : "generationInfo",
  i      : 1,
  ffvals : {
    best  : 0.79114577 ,
    avg   : 0.67221454 ,
    worst : 0.09771199 
  }
};

var cmd6 = {
  type   : "generationInfo",
  i      : 2,
  ffvals : {
    best  : 0.79914577 ,
    avg   : 0.68221454 ,
    worst : 0.19771199 
  }
};

var cmd7 = {
  type : 'multi',
  cmds : [cmd4,cmd5,cmd6]
};


var runCmd = function(){  
  
  var cmdHandlers = {

    stdout : function( cmdObj ){
      var texta = $('#texta');
      texta.append( cmdObj.msg + '\n' );
      texta[0].scrollTop = texta[0].scrollHeight;
    },

    graph : function( cmdObj ){
      var newPoints = !_.isArray( cmdObj.data[0] )  ? [cmdObj.data] : cmdObj.data ;
      var oldPoints = plotData[cmdObj.graph] ? plotData[cmdObj.graph] : [] ;
      plotData[cmdObj.graph] = oldPoints.concat(newPoints);
      drawPlot();
    },

    multi : function( cmdObj ){
      for( var i = 0 ; i < cmdObj.cmds.length ; i++ ){
        runCmd( cmdObj.cmds[i] );
      }
    },

    generationInfo : function( cmdObj ){

      var runGraphCmd = function( g , x , y ){
        runCmd( { type  : 'graph' ,
                  graph : g ,
                  data :  [x,y] } );
      };

      runGraphCmd( 'best'  + cmdObj.run , cmdObj.i , cmdObj.ffvals.best  );
      runGraphCmd( 'avg'   + cmdObj.run , cmdObj.i , cmdObj.ffvals.avg   );
      runGraphCmd( 'worst' + cmdObj.run , cmdObj.i , cmdObj.ffvals.worst );

    },

    jsonout : function( cmdObj ){

      console.log( 'jsonout: ' + JSON.stringify( cmdObj ) ) ;

    },

  };

  return function( cmdObj ){
    if( cmdHandlers[ cmdObj.type ] ){
      return cmdHandlers[ cmdObj.type ](cmdObj);  
    } else {
      console.log('ERROR : Command has unsupported type: "'+ cmdObj.type +'"');
    }
    
  };

}();





    </script>

  </head>
  <body>


    <div class="row">&nbsp;</div>

    <div class="row">

      <div class="span0"></div>

      <div class="span10">

        <div class="form-inline">
          <input type="text" class="input-small main-input" id="yayi">
          &nbsp;
          <a class="btn" onclick="yay()">Run!</a>
        </div>

      </div>

      <div class="span10">&nbsp;</div>

    </div>

    <div class="row">

      <div class="span0"></div>

      <div class="span10">

        <ul class="nav nav-tabs" id="myTab">
          <li class="active"><a href="#opts">options</a></li>
          <li><a href="#stdout" id="stdout-link">stdout</a></li>
          <li><a href="#graph1" id="graph1-link">graph 1</a></li>
          <li><a href="#graph2">graph 2</a></li>
        </ul>

      </div>

    </div>



    <div class="row">

      <div class="span0"></div>

      <div class="tab-content">

        <div class="active tab-pane span7" id="opts">
          <div class="form-horizontal">

            <div class="control-group">
              <label class="control-label" for="problem-select">Problem</label>
              <div class="controls">
                <select id="problem-select">
                  <option>Simple Symbolic Regression [ssr]</option>
                </select>
              </div>
            </div>

            <div class="control-group">
              <label class="control-label" for="numruns-input">Runs</label>
              <div class="controls">
                <table>
                  <tr>
                    <td><input id="numruns-input" type="text" class="input-for-slider"></td>
                    <td><div id="numruns-slider" class="slider"></div></td>
                  </tr>
                </table>
              </div>
            </div>

            <div class="control-group">
              <label class="control-label" for="numgens-input">Generations</label>
              <div class="controls">
                <table>
                  <tr>
                    <td><input id="numgens-input" type="text" class="input-for-slider"></td>
                    <td><div id="numgens-slider" class="slider"></div></td>
                  </tr>
                </table>
              </div>
            </div>

            <div class="control-group">
              <label class="control-label" for="popsize-input">Population size</label>
              <div class="controls">
                <table>
                  <tr>
                    <td><input id="popsize-input" type="text" class="input-for-slider"></td>
                    <td><div id="popsize-slider" class="slider"></div></td>
                  </tr>
                </table>
              </div>
            </div>

          </div>
        </div>

        <div class="tab-pane span7" id="stdout">
          <textarea rows="23" class="stdout" id="texta"></textarea>
          <a class="btn" onclick="clrscr()">clrscr</a>
        </div>

        <div class="tab-pane span7" id="graph1">
          <div id="placeholder" class="graph1"></div>
        </div>

        <div class="tab-pane span7" id="graph2">Graph 2</div>

      </div>

    </div>

  </body>
</html>